import 'dart:convert';

import 'package:get/get.dart';
import 'package:vncitizens_authentication/vncitizens_authentication.dart';
import 'package:vncitizens_home/src/models/place_model.dart';
import 'package:http/http.dart' as http;

const size = 10;
const svcPlacePf = 'pl/place';

class PlaceService {
  final String apiGatewayURL;

  PlaceService({required this.apiGatewayURL});

  Future<List<PlaceModel>> fetchPlace(
      {required String placeTagId, required int page}) async {
    final AuthenticationController authenticationController = Get.find();
    final accessToken = authenticationController.getAccessToken();

    final response = await http.get(
      Uri.parse(
          '$apiGatewayURL/$svcPlacePf/--search?tag-id=$placeTagId&page=$page&size=$size'),
      headers: {
        'Authorization':
            'Bearer eyJhbGciOiJSUzI1NiIsInR5cCIgOiAiSldUIiwia2lkIiA6ICJqazlObnpLTWVTeTF6Wk53RW1WMHVzY0FFcWFicTY4MGh5ZFpqY2Q0Wl9zIn0.eyJleHAiOjE2NDAwNzkwNzMsImlhdCI6MTY0MDA3NjUxMywiYXV0aF90aW1lIjoxNjQwMDc1NDczLCJqdGkiOiI1YTg3MjBmYi1jZWJhLTRiMDAtODQ5Yy01ODI3ZmE1MTdhZDkiLCJpc3MiOiJodHRwczovL3Nzb3Rlc3Qudm5wdGlnYXRlLnZuL2F1dGgvcmVhbG1zL2RpZ28iLCJhdWQiOiJhY2NvdW50Iiwic3ViIjoiZjpjMDk4ZmY5Zi1kYzllLTQyYjctOTE2Yy1kYjgxYTRiOGZkNzg6YWRtaW50ZXN0IiwidHlwIjoiQmVhcmVyIiwiYXpwIjoid2ViLWNpdGl6ZW5zYWRtIiwibm9uY2UiOiJhMzNiZmI1Yy1lOTM5LTRhNGQtOGIwZi0yMDlkZjNlNWNmMmYiLCJzZXNzaW9uX3N0YXRlIjoiZGE3NmQ2YzctNTY1Ny00OTA0LWFhNWQtNmVjYmQ3N2FiNTdlIiwiYWNyIjoiMCIsImFsbG93ZWQtb3JpZ2lucyI6WyJodHRwczovL2FwaXRlc3QuZGlnaWdvdi52biIsImh0dHBzOi8vcXVhbnRyaWFwcHRlc3QuZGlnaWdvdi52biIsImh0dHBzOi8vY292aWR0ZXN0LmRpZ2lnb3Yudm4iLCJodHRwczovL2FwaXRlc3Qudm5wdGlnYXRlLnZuIiwiaHR0cDovL2xvY2FsaG9zdDo0MjAwIl0sInJlYWxtX2FjY2VzcyI6eyJyb2xlcyI6WyJBQ1RJVklUSV9NT0RFTEVSIiwiQVBTX1VTRVIiLCJvZmZsaW5lX2FjY2VzcyIsIkFDVElWSVRJX0FETUlOIiwiQUNUSVZJVElfVVNFUiIsIkFQU19NT0RFTEVSIiwidW1hX2F1dGhvcml6YXRpb24iXX0sInJlc291cmNlX2FjY2VzcyI6eyJhY2NvdW50Ijp7InJvbGVzIjpbIm1hbmFnZS1hY2NvdW50IiwibWFuYWdlLWFjY291bnQtbGlua3MiLCJ2aWV3LXByb2ZpbGUiXX19LCJzY29wZSI6Im9wZW5pZCBlbWFpbCBwcm9maWxlIiwiYWNjb3VudF9pZCI6IjVmZTk4MWJmYjM4ZGY2MTRlZDQxMzI3ZSIsImVtYWlsX3ZlcmlmaWVkIjpmYWxzZSwidXNlcl9pZCI6IjVmZTk4MWJmZTQwYmUzMGY2NWYyZWYyZCIsInBlcm1pc3Npb25zIjpbeyJwZXJtaXNzaW9uIjp7ImNvZGUiOiJjZHRhZG1UYWdNYW5hZ2VtZW50In19LHsicGVybWlzc2lvbiI6eyJjb2RlIjoiY2R0YWRtUm9sZU1hbmFnZW1lbnQifX0seyJwZXJtaXNzaW9uIjp7ImNvZGUiOiJjZHRhZG1BY2NvdW50RGVjZW50cmFsaXphdGlvbiJ9fSx7InBlcm1pc3Npb24iOnsiY29kZSI6ImNkdGFkbUxhbmd1YWdlTWFuYWdlbWVudCJ9fSx7InBlcm1pc3Npb24iOnsiY29kZSI6ImNkdGFkbUFnZW5jeUxldmVsTWFuYWdlbWVudCJ9fSx7InBlcm1pc3Npb24iOnsiY29kZSI6ImNkdGFkbUNhcmVlck1hbmFnZW1lbnQifX0seyJwZXJtaXNzaW9uIjp7ImNvZGUiOiJjZHRhZG1QbGFjZVR5cGVNYW5hZ2VtZW50In19LHsicGVybWlzc2lvbiI6eyJjb2RlIjoiY2R0YWRtTmF0aW9uTWFuYWdlbWVudCJ9fSx7InBlcm1pc3Npb24iOnsiY29kZSI6ImNkdGFkbUFkdmFuY2VkQWRtaW5pc3RyYXRvciJ9fSx7InBlcm1pc3Npb24iOnsiY29kZSI6ImNkdGFkbUFjY291bnRNYW5hZ2VtZW50In19LHsicGVybWlzc2lvbiI6eyJjb2RlIjoiY2R0YWRtUGxhY2VNYW5hZ2VtZW50In19LHsicGVybWlzc2lvbiI6eyJjb2RlIjoiY2R0YWRtUG9zaXRpb25NYW5hZ2VtZW50In19LHsicGVybWlzc2lvbiI6eyJjb2RlIjoiY2R0YWRtQ2F0ZWdvcnlUYWdNYW5hZ2VtZW50In19LHsicGVybWlzc2lvbiI6eyJjb2RlIjoiY2R0YWRtVW5pdE1hbmFnZW1lbnQifX0seyJwZXJtaXNzaW9uIjp7ImNvZGUiOiJjZHRhZG1FdGhuaWNNYW5hZ2VtZW50In19LHsicGVybWlzc2lvbiI6eyJjb2RlIjoiY2R0YWRtUGVybWlzc2lvbk1hbmFnZW1lbnQifX0seyJwZXJtaXNzaW9uIjp7ImNvZGUiOiJjZHRhZG1BcHBsaWNhdGlvbk1hbmFnZW1lbnQifX0seyJwZXJtaXNzaW9uIjp7ImNvZGUiOiJjZHRhZG1QYXR0ZXJuTWFuYWdlbWVudCJ9fSx7InBlcm1pc3Npb24iOnsiY29kZSI6ImNkdGFkbUFnZW5jeU1hbmFnZW1lbnQifX0seyJwZXJtaXNzaW9uIjp7ImNvZGUiOiJjZHRhZG1SZWxpZ2lvbk1hbmFnZW1lbnQifX0seyJwZXJtaXNzaW9uIjp7ImNvZGUiOiJwZXRpdGlvbkFjY2VwdGVyIn19LHsicGVybWlzc2lvbiI6eyJjb2RlIjoicGV0aXRpb25NYW5hZ2VyIn19LHsicGVybWlzc2lvbiI6eyJjb2RlIjoicGV0aXRpb25Db25maWd1cmF0aW9uIn19LHsicGVybWlzc2lvbiI6eyJjb2RlIjoicGV0aXRpb25TdGF0aWN0aXNCeVRhZyJ9fSx7InBlcm1pc3Npb24iOnsiY29kZSI6InBldGl0aW9uU3RhdGljdGlzQnlMaXN0In19LHsicGVybWlzc2lvbiI6eyJjb2RlIjoicGV0aXRpb25BZG1pbiJ9fSx7InBlcm1pc3Npb24iOnsiY29kZSI6InBldGl0aW9uU3RhdGljdGlzQnlBbm9ueW1vdXMifX0seyJwZXJtaXNzaW9uIjp7ImNvZGUiOiJwZXRpdGlvblJlc29sdmVyIn19LHsicGVybWlzc2lvbiI6eyJjb2RlIjoicGV0aXRpb25BcHByb3ZlciJ9fSx7InBlcm1pc3Npb24iOnsiY29kZSI6InJlcG9ydGVyQWRtaW5NYXN0ZXIifX0seyJwZXJtaXNzaW9uIjp7ImNvZGUiOiJwZXRpdGlvbkRlbGV0ZSJ9fSx7InBlcm1pc3Npb24iOnsiY29kZSI6Im9uZUdhdGVBZG1pbk1hc3RlciJ9fSx7InBlcm1pc3Npb24iOnsiY29kZSI6InBhZHN2Y2FkbU1hc3RlciJ9fSx7InBlcm1pc3Npb24iOnsiY29kZSI6InBldGl0aW9uU2NvcGUzIn19LHsicGVybWlzc2lvbiI6eyJjb2RlIjoicGV0aXRpb25BZ2VuY3lTdGF0aXN0aWNzVEcifX0seyJwZXJtaXNzaW9uIjp7ImNvZGUiOiJwZXRpdGlvbkNoYW5uZWxTdGF0aXN0aWNzVEcifX0seyJwZXJtaXNzaW9uIjp7ImNvZGUiOiJhY3Rpdml0aU1vZGVsZXIifX0seyJwZXJtaXNzaW9uIjp7ImNvZGUiOiJhY3Rpdml0aUFkbWluIn19LHsicGVybWlzc2lvbiI6eyJjb2RlIjoiSU9DVmlldyJ9fSx7InBlcm1pc3Npb24iOnsiY29kZSI6InZuY2l0aXplbnNBZG1pbk1hc3RlciJ9fSx7InBlcm1pc3Npb24iOnsiY29kZSI6ImludGVncmF0aW9uQWRtaW4ifX0seyJwZXJtaXNzaW9uIjp7ImNvZGUiOiJtYW5hZ2VIZWFsdGgifX0seyJwZXJtaXNzaW9uIjp7ImNvZGUiOiJjaXRpemVuc2FkbUNvdmlkRGF0YSJ9fSx7InBlcm1pc3Npb24iOnsiY29kZSI6ImNpdGl6ZW5zYWRtQ292aWRQYXRpZW50In19LHsicGVybWlzc2lvbiI6eyJjb2RlIjoiY2l0aXplbnNhZG1EaXNlYXNlTmV3c0FwcHJvdmUifX0seyJwZXJtaXNzaW9uIjp7ImNvZGUiOiJjaXRpemVuc2FkbU5vZml0aWNhdGlvbkFwcHJvdmUifX0seyJwZXJtaXNzaW9uIjp7ImNvZGUiOiJtYW5hZ2VQbGFjZSJ9fSx7InBlcm1pc3Npb24iOnsiY29kZSI6Im1hbmFnZURpZ28ifX0seyJwZXJtaXNzaW9uIjp7ImNvZGUiOiJtYW5hZ2VQb3N0bWFuIn19LHsicGVybWlzc2lvbiI6eyJjb2RlIjoibWFuYWdlRmlsZW1hbiJ9fV0sIm5hbWUiOiJOZ3V54buFbiBDaMOtIFRoaeG7h24iLCJwcmVmZXJyZWRfdXNlcm5hbWUiOiJhZG1pbnRlc3QiLCJhcHBfcGVybWlzc2lvbnMiOlsiL3N2Y01lbnUvbWFuYWdlSXRlbSJdLCJkZXBsb3ltZW50X2lkIjoiNWVlMDkxNTA3ZDU2N2M5ZmUyOWY4MmZhIiwiZ2l2ZW5fbmFtZSI6Ik5ndXnhu4VuIENow60gVGhp4buHbiJ9.J1-JJHIJOXUptb05ohU1dgxVKEzQM0JekGZG0IhnsR-EDpct96SfsCFjPDVEcgs1e6sqiIbOuiek0M2J5QriR3V4oNCheUMR-XOW1evaVtBXyrYOCCbnLpfIR69N1bD05iZHJabOREcLdMXn0OifoC-5y4pIZSMskeZBlwkNLPZ4ukJ9l1TOD_IL9FADD1Jkf09QQz2Ns1riTR_BkBJpgUhVS4OcuwpjIswz4VQOOyjV9CmKpT_5HZIeBP31FeFmGz0Y59C67RLr1AVI64VhtinFk4sjVBBUGsC37Sve7MIyxoZxo0BDl18ZOO05hbPp-PfHuDhzbSeVdzRdGUQ2cQ'
      },
    );
    if (response.statusCode == 200) {
      final body =
          json.decode(utf8.decode(response.bodyBytes))['content'] as List;

      return body.map(
        (dynamic json) {
          return PlaceModel(
            id: json['id'] ?? '',
            name: json['name'] ?? '',
            icon: json['thumbnail'] ?? '',
            latitude: json['location']['latitude'] ?? 0,
            longitude: json['location']['longitude'] ?? 0,
            phoneNumber: json['phoneNumber'] ?? '',
            address: json['baPlace']['address'] ?? '',
          );
        },
      ).toList();
    }
    throw Exception(response.body);
  }
}
